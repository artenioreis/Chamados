{% extends "base.html" %}
{% block content %}
<div class="row mt-4">
    <div class="col-12 mb-3">
        <img src="{% if system_settings and system_settings.logo_filename %}{{ url_for('static', filename='uploads/' + system_settings.logo_filename) }}{% else %}https://neosul.com.br/clientes/1/img/logo.png{% endif %}" alt="Logo" style="max-width: 250px; height: auto;">
    </div>
</div>
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h1 class="mb-0"><i class="fas fa-comments me-2"></i>Conversas</h1>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <input type="text" id="chatSearch" class="form-control" placeholder="Buscar por nome do utilizador...">
        </div>

        <div class="list-group list-group-flush">
            
            {% if conversations %}
                {% for msg in conversations %}
                    {% set other_user = msg.sender if msg.sender_id != current_user.id else msg.recipient %}
                    <a href="{{ url_for('main.chat_conversation', recipient_id=other_user.id) }}" class="list-group-item list-group-item-action conversation-item" data-name="{{ other_user.name.lower() }}" data-conversation-with="{{ other_user.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 conversation-title">
                                {{ other_user.name }}
                                <span class="badge bg-danger rounded-pill ms-2 unread-indicator" style="display: none;">!</span>
                            </h5>
                            <small class="text-muted">{{ msg.timestamp | localdatetime }}</small>
                        </div>
                        <p class="mb-1 text-muted conversation-preview">
                            {% if msg.content %}
                                {{ msg.content | truncate(80) }}
                            {% else %}
                                <i class="fas fa-paperclip"></i> Anexo
                            {% endif %}
                        </p>
                    </a>
                {% endfor %}
            {% endif %}

            {% if users_without_conversations %}
                <div class="list-group-item bg-light new-conversation-header {% if not conversations and not users_without_conversations %}d-none{% endif %}">
                    <small class="text-muted text-uppercase">Iniciar nova conversa</small>
                </div>
                {% for user in users_without_conversations %}
                <a href="{{ url_for('main.chat_conversation', recipient_id=user.id) }}" class="list-group-item list-group-item-action conversation-item" data-name="{{ user.name.lower() }}">
                    <h5 class="mb-1">{{ user.name }}</h5>
                    <small class="text-muted">{{ user.sector }}</small>
                </a>
                {% endfor %}
            {% endif %}

            <div id="no-results" class="list-group-item text-center text-muted py-3" style="display: none;">
                Nenhum utilizador encontrado.
            </div>

            {% if not conversations and not users_without_conversations %}
                <div class="list-group-item">
                    <p class="text-muted my-3 text-center">Nenhum utilizador disponível para conversar.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<audio id="chat-page-notification-sound" src="{{ url_for('static', filename='audio/notification.mp3') }}" preload="auto"></audio>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica da busca
    const searchInput = document.getElementById('chatSearch');
    const conversationItems = document.querySelectorAll('.conversation-item');
    const noResultsMessage = document.getElementById('no-results');
    const newConversationHeader = document.querySelector('.new-conversation-header');

    searchInput.addEventListener('keyup', function() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleItems = 0;

        conversationItems.forEach(function(item) {
            const userName = item.getAttribute('data-name');
            if (userName.includes(searchTerm)) {
                item.style.display = '';
                visibleItems++;
            } else {
                item.style.display = 'none';
            }
        });

        if (visibleItems === 0 && searchTerm !== '') {
            noResultsMessage.style.display = 'block';
            if(newConversationHeader) newConversationHeader.style.display = 'none';
        } else {
            noResultsMessage.style.display = 'none';
            if(newConversationHeader) newConversationHeader.style.display = '';
        }
    });

    // --- LÓGICA DE NOTIFICAÇÃO DE MENSAGENS NÃO LIDAS ---
    const notificationSound = document.getElementById('chat-page-notification-sound');
    let knownUnreadSenders = new Set(); // Guarda os remetentes que já sabemos que têm mensagens não lidas

    function checkUnreadMessages() {
        fetch("{{ url_for('main.unread_info') }}")
            .then(response => response.json())
            .then(data => {
                const unreadSenders = new Set(data.unread_senders || []);
                let newNotification = false;

                // Verifica se há um novo remetente não lido que não conhecíamos antes
                unreadSenders.forEach(senderId => {
                    if (!knownUnreadSenders.has(senderId)) {
                        newNotification = true;
                    }
                });
                
                // Atualiza o nosso conhecimento sobre quem tem mensagens não lidas
                knownUnreadSenders = unreadSenders;

                // Toca o som APENAS se houver uma nova notificação
                if (newNotification && notificationSound) {
                    notificationSound.play().catch(error => console.log("A reprodução do som falhou. É necessária a interação do utilizador.", error));
                }
                
                // Atualiza a interface visual (pontos vermelhos e negrito)
                document.querySelectorAll('.conversation-item').forEach(item => {
                    const conversationId = parseInt(item.getAttribute('data-conversation-with'), 10);
                    const indicator = item.querySelector('.unread-indicator');
                    const title = item.querySelector('.conversation-title');
                    const preview = item.querySelector('.conversation-preview');

                    if (unreadSenders.has(conversationId)) {
                        if (indicator) indicator.style.display = 'inline-block';
                        if (title) title.style.fontWeight = 'bold';
                        if (preview) preview.style.fontWeight = 'bold';
                    } else {
                        if (indicator) indicator.style.display = 'none';
                        if (title) title.style.fontWeight = 'normal';
                        if (preview) preview.style.fontWeight = 'normal';
                    }
                });
            })
            .catch(error => console.error('Erro ao verificar mensagens não lidas:', error));
    }

    // Verifica a cada 10 segundos
    checkUnreadMessages();
    setInterval(checkUnreadMessages, 10000); 
});
</script>
{% endblock %}