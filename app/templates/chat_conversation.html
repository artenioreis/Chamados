{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0"><i class="fas fa-comments me-2"></i>Chat com {{ recipient.name }}</h1>
    <div>
        <a href="{{ url_for('main.chat_users') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header p-2">
        <div class="input-group">
            <input type="text" id="messageSearch" class="form-control border-0" placeholder="Buscar nesta conversa...">
            <button class="btn btn-light border" type="button" id="clearSearchBtn" style="display: none;"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column;">
        </div>
    <div class="card-footer">
        <form id="chat-form" method="POST" action="{{ url_for('main.chat_conversation', recipient_id=recipient.id) }}" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="input-group mb-2">
                {{ form.content(class="form-control", placeholder="Digite sua mensagem...", autocomplete="off", rows="1") }}
            </div>
            <div id="form-errors" class="text-danger small mt-1 mb-2"></div>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {{ form.attachment(class="form-control form-control-sm") }}
                </div>
                {{ form.submit(class="btn btn-primary", id="submit-button") }}
            </div>
        </form>
    </div>
</div>

<audio id="chat-notification-sound" src="{{ url_for('static', filename='audio/notification.mp3') }}" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatBox = document.getElementById('chat-box');
    const recipientId = {{ recipient.id }};
    const notificationSound = document.getElementById('chat-notification-sound');
    const messageSearchInput = document.getElementById('messageSearch');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    let messageCount = 0;
    let isInitialLoad = true;
    let messagesCache = [];

    // --- NOVA FUNÇÃO PARA MARCAR MENSAGENS COMO LIDAS ---
    function markMessagesAsRead() {
        fetch(`/api/chat/${recipientId}/mark_as_read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).catch(error => console.error('Erro ao marcar mensagens como lidas:', error));
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function renderMessages(messagesToRender, searchTerm = '') {
        chatBox.innerHTML = '';
        if (messagesToRender.length === 0) {
            chatBox.innerHTML = '<div class="text-center text-muted my-auto">Nenhuma mensagem encontrada.</div>';
            return;
        }

        messagesToRender.forEach(msg => {
            let contentHtml = msg.content ? `<div style="white-space: pre-wrap;">${msg.content}</div>` : '';
            
            if (searchTerm && msg.content && msg.content.toLowerCase().includes(searchTerm)) {
                const regex = new RegExp(searchTerm, 'gi');
                contentHtml = msg.content.replace(regex, (match) => `<mark>${match}</mark>`);
            }

            const messageClass = msg.is_current_user ? 'align-self-end' : 'align-self-start';
            const bubbleClass = msg.is_current_user ? 'bg-primary text-white' : 'bg-light text-dark';
            
            let attachmentHtml = '';
            if (msg.attachment_url) {
                attachmentHtml = `
                    <div class="mt-2">
                        <a href="${msg.attachment_url}" target="_blank" class="${msg.is_current_user ? 'text-white' : 'text-dark'}" style="text-decoration: underline;">
                            <i class="fas fa-paperclip me-1"></i> ${msg.attachment_filename}
                        </a>
                    </div>
                `;
            }

            const messageElement = `
                <div class="d-flex flex-column mb-2 message-item ${messageClass}" style="max-width: 75%;">
                    <div class="p-2 rounded ${bubbleClass}">
                        ${contentHtml}
                        ${attachmentHtml}
                    </div>
                    <div class="small text-muted mt-1" style="font-size: 0.75rem;">
                        ${msg.sender_name}, ${formatTimestamp(msg.timestamp)}
                    </div>
                </div>
            `;
            chatBox.innerHTML += messageElement;
        });
    }


    function fetchMessages() {
        fetch(`/api/chat/${recipientId}/messages`)
            .then(response => response.json())
            .then(messages => {
                messagesCache = messages; 

                if (messages.length > messageCount && !isInitialLoad) {
                    const lastMessage = messages[messages.length - 1];
                    if (lastMessage && !lastMessage.is_current_user) {
                        notificationSound.play().catch(error => console.log("A reprodução do áudio falhou:", error));
                        markMessagesAsRead(); // Marca como lida ao receber nova mensagem
                    }
                }
                
                const shouldScroll = isInitialLoad || (chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 50);
                messageCount = messages.length;

                renderMessages(messagesCache);
                
                if (shouldScroll) {
                    scrollToBottom();
                }
                isInitialLoad = false;
            });
    }

    // --- LÓGICA PRINCIPAL ---
    markMessagesAsRead(); // Marca como lida assim que entra na conversa
    fetchMessages();
    setInterval(fetchMessages, 5000);

    const chatForm = document.getElementById('chat-form');
    const submitButton = document.getElementById('submit-button');
    const errorDiv = document.getElementById('form-errors');

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitButton.disabled = true;
        errorDiv.textContent = '';

        const formData = new FormData(chatForm);
        
        fetch(chatForm.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatForm.reset();
                fetchMessages();
            } else {
                if (data.errors && data.errors.content) {
                    errorDiv.textContent = data.errors.content.join(', ');
                } else {
                    errorDiv.textContent = 'Ocorreu um erro ao enviar a mensagem.';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'Erro de conexão. Tente novamente.';
        })
        .finally(() => {
            submitButton.disabled = false;
        });
    });

    messageSearchInput.addEventListener('keyup', function() {
        const searchTerm = messageSearchInput.value.toLowerCase().trim();

        if (searchTerm) {
            clearSearchBtn.style.display = 'block';
            const filteredMessages = messagesCache.filter(msg => 
                msg.content && msg.content.toLowerCase().includes(searchTerm)
            );
            renderMessages(filteredMessages, searchTerm);
        } else {
            clearSearchBtn.style.display = 'none';
            renderMessages(messagesCache);
        }
    });

    clearSearchBtn.addEventListener('click', function() {
        messageSearchInput.value = '';
        clearSearchBtn.style.display = 'none';
        renderMessages(messagesCache);
        scrollToBottom();
    });
});
</script>
{% endblock %}